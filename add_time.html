<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>PC視聴時間管理</title>
  <link rel="icon" href="data:,">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="common.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* 共通スタイルはcommon.cssに移動 */
    .input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }

    #memoInput {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    .pc-list {
      margin-bottom: 20px;
    }
    .pc-item {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .pc-name {
      font-weight: bold;
      margin-bottom: 8px;
    }
    .time-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      font-size: 0.9em;
    }
    .time-adjust {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }
    input[type="number"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100px;
    }
    button {
      padding: 8px 16px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #1d4ed8;
    }
    .error {
      color: #dc2626;
      margin-top: 10px;
    }
    .success {
      color: #16a34a;
      margin-top: 10px;
    }
    .time-log {
      margin-top: 20px;
      font-size: 0.9em;
    }
    .time-log-item {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>
  <!-- 共通ヘッダーの読み込み（直接fetchせず、common-header.js を利用） -->
  <div id="commonHeader"></div>
  <script src="common-header.js"></script>

  <div class="card">
    <div id="pcList" class="pc-list">
      <!-- PCごとの情報がここに表示されます -->
    </div>
    
    <div class="time-adjust">
      <h3>視聴時間の調整</h3>
      <div class="input-group">
        <input type="number" id="minutesInput" placeholder="分数">
        <input type="text" id="memoInput" placeholder="メモ（任意）" style="flex: 1;">
        <button id="submitButton">追加/削減</button>
      </div>
      <div id="message"></div>
    </div>

    <div class="time-log">
      <h3>本日の時間調整ログ</h3>
      <div id="timeLogList">
        <!-- 時間調整ログがここに表示されます -->
      </div>
    </div>
  </div>

  <script>
    // グローバル変数として Supabase の URL は既に定義されている前提です
    const SUPABASE_PROJECT_ID = 'xalrqqutkxzwzvahqpjg';
    const SUPABASE_URL = `https://${SUPABASE_PROJECT_ID}.supabase.co`;

    // グローバル変数としてsupabaseClientを1つだけ保持
    let supabaseClient;
    let USER_ID = null;

    // APIリクエスト用のヘッダーを定義
    const HEADERS = {
      'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhbHJxcXV0a3h6d3p2YWhxcGpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzkyNDE2MDIsImV4cCI6MjA1NDgxNzYwMn0.OzfyNlLHmZJOiWnCgsUCnvA9npaDXzVeASr-HVOT1MA',
      'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhbHJxcXV0a3h6d3p2YWhxcGpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzkyNDE2MDIsImV4cCI6MjA1NDgxNzYwMn0.OzfyNlLHmZJOiWnCgsUCnvA9npaDXzVeASr-HVOT1MA',
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal'
    };

    window.onload = function() {
      const urlParams = new URLSearchParams(window.location.search);
      const SUPABASE_KEY = urlParams.get('supabase_key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhbHJxcXV0a3h6d3p2YWhxcGpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzkyNDE2MDIsImV4cCI6MjA1NDgxNzYwMn0.OzfyNlLHmZJOiWnCgsUCnvA9npaDXzVeASr-HVOT1MA';

      // supabaseClientが未初期化の場合のみ初期化を行う
      if (!supabaseClient) {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
          auth: {
            autoRefreshToken: true,
            persistSession: true,
            detectSessionInUrl: true
          }
        });
      }

      // 初期化を実行
      initializeWithSession();
    };

    // セッションチェックと初期化
    async function initializeWithSession() {
      try {
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError) throw sessionError;
        if (!session) {
          window.location.href = 'auth_test_login.html';
          return;
        }

        USER_ID = session.user.id;
        // データ取得を開始
        await displayPCInfo();
        await displayTimeLog();

      } catch (error) {
        console.error('セッション初期化エラー:', error);
        window.location.href = 'auth_test_login.html';
      }
    }

    // 今日の日付を取得（JST）
    function getTodayJST() {
      const now = new Date();
      const jstDate = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      return jstDate.toISOString().split('T')[0];
    }

    // 分を HH:MM 形式に変換
    function getTimeString(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    }

    // 指定時刻（時、分）から総分数を取得
    function getMinutesFromTime(hours, minutes) {
      return hours * 60 + minutes;
    }

    // 時刻レンジ文字列（例："16:50-17:30"）をパース
    function parseTimeRange(rangeStr) {
      const [startStr, endStr] = rangeStr.split('-');
      const [startHour, startMin] = startStr.split(':').map(n => parseInt(n, 10));
      const [endHour, endMin] = endStr.split(':').map(n => parseInt(n, 10));
      return {
        start: getMinutesFromTime(startHour, startMin),
        end: getMinutesFromTime(endHour, endMin)
      };
    }

    // 時間帯の配列をマージ（重複・連続する範囲を統合）
    function mergeTimeRanges(ranges) {
      // 重複を除去
      ranges = [...new Set(ranges)];
      
      // 文字列を数値に変換してソート
      const parsed = ranges.map(range => parseTimeRange(range))
        .sort((a, b) => a.start - b.start);
      
      const merged = [];
      let current = null;
      
      for (const range of parsed) {
        if (!current) {
          current = { ...range };
          continue;
        }

        if (range.start <= current.end) {
          current.end = Math.max(current.end, range.end);
        } else {
          merged.push(`${getTimeString(current.start)}-${getTimeString(current.end)}`);
          current = { ...range };
        }
      }
      
      if (current) {
        merged.push(`${getTimeString(current.start)}-${getTimeString(current.end)}`);
      }
      
      return merged;
    }

    // PC名を取得する関数
    async function getPcName(pcId) {
      const requestBody = { p_pc_id: pcId };
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/rpc/get_pc_name`,
          {
            method: 'POST',
            headers: HEADERS,
            body: JSON.stringify(requestBody)
          }
        );
        if (!response.ok) {
          throw new Error(`PC name fetch error: ${response.status}`);
        }
        const pcName = await response.json();
        return pcName || pcId;
      } catch (error) {
        console.error('Error fetching PC name:', error);
        return pcId;
      }
    }

    // 分析サマリー表示用の関数
    async function displayAnalysisSummary() {
      try {
        const today = getTodayJST();
        const requestBody = {
          target_user_id: USER_ID,
          target_date: today
        };

        // 許可時間情報の取得（RPC: get_total_watch_time）
        const totalResponse = await fetch(
          `${SUPABASE_URL}/rest/v1/rpc/get_total_watch_time`,
          {
            method: 'POST',
            headers: HEADERS,
            body: JSON.stringify(requestBody)
          }
        );
        if (!totalResponse.ok) {
          throw new Error('合計視聴時間の取得に失敗しました');
        }
        const totalDataArray = await totalResponse.json();
        const totalData = totalDataArray[0] || {};

        // 利用時間差分情報の取得（RPC: analyze_time_difference）
        const diffResponse = await fetch(
          `${SUPABASE_URL}/rest/v1/rpc/analyze_time_difference`,
          {
            method: 'POST',
            headers: HEADERS,
            body: JSON.stringify(requestBody)
          }
        );
        if (!diffResponse.ok) {
          throw new Error('利用時間差分の取得に失敗しました');
        }
        const diffDataArray = await diffResponse.json();
        const diffData = diffDataArray[0] || {};

        // 差分の値に応じた注釈を付与（正の場合：超過、負の場合：許容）
        const timeDifference = diffData.time_difference || 0;
        let diffAnnotation = "";
        if (timeDifference > 0) {
          diffAnnotation = "（超過してる）";
        } else if (timeDifference < 0) {
          diffAnnotation = "（許容）";
        }

        // 分析サマリー表示用の要素を取得または作成
        let summaryElement = document.getElementById('analysisSummary');
        if (!summaryElement) {
          summaryElement = document.createElement('div');
          summaryElement.id = 'analysisSummary';
          summaryElement.style.margin = '20px 0';
          summaryElement.style.fontSize = '1em';
          summaryElement.style.fontWeight = 'bold';
          document.querySelector('.card').insertBefore(summaryElement, document.querySelector('.time-adjust'));
        }

        // 許可時間と利用時間の両方を表示
        summaryElement.innerHTML = `
          許可: ${totalData.total_time || 0}分 (追加: ${totalData.total_added_minutes || 0}分, ベース: ${totalData.default_time || 0}分)
          <br>
          利用時間: ${diffData.unique_minutes_count || 0}分, 差分: ${timeDifference}分${diffAnnotation}
        `;
      } catch (error) {
        console.error('分析サマリー取得エラー:', error);
      }
    }

    // PCごとの情報を表示する関数
    async function displayPCInfo() {
      try {
        const today = getTodayJST();
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/rpc/get_time_ranges_by_user`,
          {
            method: 'POST',
            headers: HEADERS,
            body: JSON.stringify({
              target_user_id: USER_ID,
              target_date: today
            })
          }
        );
        if (!response.ok) throw new Error('データの取得に失敗しました');
        
        const data = await response.json();
        const pcListElement = document.getElementById('pcList');
        pcListElement.innerHTML = '';

        // PCごとの情報を表示
        for (const row of data) {
          let timeRanges = row.time_ranges;
          if (typeof timeRanges === 'string') {
            timeRanges = JSON.parse(timeRanges);
          }
          const mergedRanges = mergeTimeRanges(timeRanges);
          let usedMinutes = 0;
          mergedRanges.forEach(rangeStr => {
            const { start, end } = parseTimeRange(rangeStr);
            usedMinutes += (end - start);
          });
          const pcName = await getPcName(row.pc_id);
          const pcElement = document.createElement('div');
          pcElement.className = 'pc-item';
          pcElement.innerHTML = `
            <div class="pc-name">${pcName}</div>
            <div class="time-info">
              <div>視聴時間: ${usedMinutes}分</div>
              <div>利用回数: ${row.activity_count}回</div>
            </div>
          `;
          pcListElement.appendChild(pcElement);
        }

        // 分析サマリーを表示
        displayAnalysisSummary();

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('message').innerHTML = `
          <div class="error">エラーが発生しました: ${error.message}</div>
        `;
      }
    }

    // 時間調整ログを表示する関数
    async function displayTimeLog() {
      try {
        const today = getTodayJST();
        // 当日開始・終了時刻（ISO フォーマット：YYYY-MM-DDT00:00:00 / YYYY-MM-DDT23:59:59）
        const startTime = today + "T00:00:00";
        const endTime = today + "T23:59:59";
        const response = await fetch(
          // watch_time_log テーブルから当日のログを取得するクエリ例
          `${SUPABASE_URL}/rest/v1/watch_time_log?user_id=eq.${USER_ID}&created_at_jst=gte.${startTime}&created_at_jst=lte.${endTime}`,
          {
            headers: HEADERS
          }
        );
        
        if (!response.ok) throw new Error('ログの取得に失敗しました');
        
        const logs = await response.json();
        const logListElement = document.getElementById('timeLogList');
        logListElement.innerHTML = '';
        
        logs.forEach(log => {
          const logElement = document.createElement('div');
          logElement.className = 'time-log-item';
          const date = new Date(log.created_at_jst);
          date.setHours(date.getHours() - 9);
          const time = date.toLocaleTimeString('ja-JP', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hourCycle: 'h24'
          }).replace(/(\d+):(\d+):(\d+)/, '$1時$2分 $3秒');
          
          let displayText = `${time}　　${log.added_minutes}分追加`;
          if (log.memo) {
            displayText += `　（${log.memo}）`;
          }
          
          logElement.textContent = displayText;
          logListElement.appendChild(logElement);
        });
        
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // イベントリスナーの設定
    document.getElementById('submitButton').addEventListener('click', submitTimeAdjustment);

    // --- モーダルポップアップを表示する関数を更新 ---
    function showTimeAdjustmentModal(totalAddition, originalAddition) {
      return new Promise((resolve) => {
        const modal = document.createElement("div");
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100%";
        modal.style.height = "100%";
        modal.style.backgroundColor = "rgba(0,0,0,0.5)";
        modal.style.display = "flex";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
        modal.style.zIndex = "1000";

        // モーダル外クリックのイベントリスナー追加
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
            resolve(null);
          }
        });
        
        const modalContent = document.createElement("div");
        modalContent.className = "modal-content";
        modalContent.style.padding = "20px";
        modalContent.style.borderRadius = "8px";
        modalContent.style.boxShadow = "0 2px 4px rgba(0,0,0,0.2)";
        modalContent.style.transition = "background-color 0.3s, color 0.3s";
        modalContent.style.width = "400px"; // モーダルウィンドウの横幅を400pxに設定

        // ダークモード対応
        if (document.body.classList.contains('dark-mode')) {
          modalContent.style.backgroundColor = "#2d2d2d";
          modalContent.style.color = "#e5e5e5";
          modalContent.style.borderColor = "#444";
        } else {
          modalContent.style.backgroundColor = "#fff";
          modalContent.style.color = "#000";
          modalContent.style.borderColor = "#ddd";
        }

        modalContent.innerHTML = `<p>超過分を加算して ${totalAddition} 分の追加できます。<br>どちらの追加を適用しますか？</p>`;
        
        const buttonContainer = document.createElement("div");
        buttonContainer.style.display = "flex";
        buttonContainer.style.gap = "10px";
        buttonContainer.style.marginTop = "20px";
        buttonContainer.style.justifyContent = "center";

        const createButton = (text, type = 'default') => {
          const btn = document.createElement("button");
          btn.textContent = text;
          btn.className = "btn";
          btn.style.padding = "8px 16px";
          btn.style.borderRadius = "4px";
          btn.style.cursor = "pointer";
          btn.style.transition = "all 0.3s ease";
          btn.style.width = "200%";
          
          if (document.body.classList.contains('dark-mode')) {
            switch(type) {
              case 'total':
                btn.style.backgroundColor = "#3b82f6"; // 水色
                btn.style.color = "#ffffff";
                break;
              case 'cancel':
                btn.style.backgroundColor = "#ef4444"; // 濃い赤色
                btn.style.color = "#ffffff";
                break;
              default:
                btn.style.backgroundColor = "#333";
                btn.style.color = "#e5e5e5";
                btn.style.borderColor = "#555";
            }
          }
          return btn;
        };

        const btnTotal = createButton(`${totalAddition}分追加`, 'total');
        const btnOriginal = createButton(`${originalAddition}分追加`);
        const btnCancel = createButton("キャンセル", 'cancel');
        
        btnTotal.addEventListener("click", () => {
            document.body.removeChild(modal);
            resolve(totalAddition);
        });
        
        btnOriginal.addEventListener("click", () => {
            document.body.removeChild(modal);
            resolve(originalAddition);
        });
        
        btnCancel.addEventListener("click", () => {
            document.body.removeChild(modal);
            resolve(null);
        });
        
        buttonContainer.appendChild(btnTotal);
        buttonContainer.appendChild(btnOriginal);
        buttonContainer.appendChild(btnCancel);
        modalContent.appendChild(buttonContainer);
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
      });
    }

    // --- submitTimeAdjustment 関数の変更版 ---
    async function submitTimeAdjustment() {
      let minutes = parseInt(document.getElementById('minutesInput').value);
      const memo = document.getElementById('memoInput').value.trim();
      
      if (isNaN(minutes)) {
        document.getElementById('message').innerHTML = `
          <div class="error">有効な数値を入力してください</div>
        `;
        return;
      }

      if (minutes > 0) {
        const today = getTodayJST();
        const diffResponse = await fetch(
          `${SUPABASE_URL}/rest/v1/rpc/analyze_time_difference`,
          {
            method: 'POST',
            headers: HEADERS,
            body: JSON.stringify({
              target_user_id: USER_ID,
              target_date: today
            })
          }
        );
        if (diffResponse.ok) {
          const diffDataArray = await diffResponse.json();
          const diffData = diffDataArray[0] || {};
          const timeDiff = diffData.time_difference || 0;
          if (timeDiff > 0) {
            const totalAddition = minutes + timeDiff;
            const chosenMinutes = await showTimeAdjustmentModal(totalAddition, minutes);
            if (chosenMinutes === null) {
              return;
            }
            minutes = chosenMinutes;
          }
        }
      }

      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/rpc/add_watch_time_with_memo`,
          {
            method: 'POST',
            headers: HEADERS,
            body: JSON.stringify({
              p_user_id: USER_ID,
              p_added_minutes: minutes,
              p_memo: memo || null
            })
          }
        );

        if (!response.ok) throw new Error('時間調整の登録に失敗しました');

        document.getElementById('message').innerHTML = `
          <div class="success">時間調整を登録しました</div>
        `;
        document.getElementById('minutesInput').value = '';
        document.getElementById('memoInput').value = '';

        await displayPCInfo();
        await displayTimeLog();
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('message').innerHTML = `
          <div class="error">エラーが発生しました: ${error.message}</div>
        `;
      }
    }
  </script>
</body>
</html>