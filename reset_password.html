<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>パスワード再設定</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .form-field { margin-bottom: 15px; }
    label { display: inline-block; width: 150px; }
    input { padding: 5px; }
    button { padding: 5px 10px; }
    #message { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>パスワードをリセット</h1>
  <div id="auth-status">認証チェック中...</div>
  
  <form id="resetPasswordForm" style="display: none;">
    <div class="form-field">
      <label for="newPassword">新しいパスワード:</label>
      <input type="password" id="newPassword" name="newPassword" required>
    </div>
    <button type="submit">パスワードを更新</button>
  </form>
  
  <div id="message"></div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase 初期化
    const SUPABASE_URL = "https://xalrqqutxzwzvahqpjg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhbHJxcXV0a3h6d3p2YWhxcGpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTk4OTEyMDAsImV4cCI6MjAxNTQ2NzIwMH0.KpFrYqFNEjOmDJvAEvDJXWGoXVYaPz2DTq1WwKFUaEM";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function checkAuthStatus() {
      try {
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = urlParams.get("access_token");
        const refreshToken = urlParams.get("refresh_token");

        if (!accessToken || !refreshToken) {
          document.getElementById("auth-status").textContent = "認証エラー: 正しいリンクを開いてください。";
          return;
        }

        // セッションを設定
        const { data: sessionData, error: sessionError } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken
        });

        if (sessionError) {
          console.error("Session error:", sessionError);
          document.getElementById("auth-status").textContent = "認証エラー: セッションを設定できませんでした。";
          return;
        }

        // ユーザー情報を取得
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        
        if (userError) {
          console.error("User error:", userError);
          document.getElementById("auth-status").textContent = "認証エラー: ユーザー情報を取得できませんでした。";
          return;
        }

        if (!user) {
          document.getElementById("auth-status").textContent = "認証エラー: ユーザーが見つかりません。";
          return;
        }

        // 認証成功時にフォームを表示
        document.getElementById("auth-status").style.display = "none";
        document.getElementById("resetPasswordForm").style.display = "block";
      } catch (error) {
        console.error("Unexpected error:", error);
        document.getElementById("auth-status").textContent = "予期せぬエラーが発生しました。";
      }
    }

    // ページ読み込み時に認証チェック
    window.addEventListener("DOMContentLoaded", checkAuthStatus);

    document.getElementById("resetPasswordForm").addEventListener("submit", async (event) => {
      event.preventDefault();
      const newPassword = document.getElementById("newPassword").value;
      const messageDiv = document.getElementById("message");

      try {
        // パスワードを更新
        const { data, error } = await supabase.auth.updateUser({ password: newPassword });
        
        if (error) {
          console.error("Password update error:", error);
          messageDiv.textContent = "エラー: " + error.message;
          return;
        }

        messageDiv.textContent = "パスワードが更新されました！ログインページへ移動してください。";
        setTimeout(() => {
          window.location.href = "login.html";
        }, 2000);
      } catch (error) {
        console.error("Unexpected error during password update:", error);
        messageDiv.textContent = "予期せぬエラーが発生しました。";
      }
    });
  </script>
</body>
</html>