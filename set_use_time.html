<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>PCアクティビティ登録/削除</title>
  <link rel="icon" href="data:,">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="common.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="common-header.js"></script>
  <style>
    /* ローカルのスタイルを削除し、common.cssに依存する */
  </style>
</head>
<body>
  <div id="commonHeader"></div>

  <div class="card">
    <h3>PCアクティビティ登録/削除</h3>
    
    <!-- PC選択 -->
    <div class="input-group">
      <label for="pcIdSelect">PC:</label>
      <select id="pcIdSelect">
        <option value="4e27bdfa-83f9-437f-a06b-0fc108c99039">gam</option>
        <option value="9e7ec6df-31af-4e88-ba60-66783d50bc08">H1</option>
        <option value="other">その他</option>
      </select>
      <input type="text" id="pcIdOther" placeholder="その他のPC ID" style="display:none;">
    </div>
    
    <!-- 時刻入力 -->
    <div class="input-group">
      <label for="timeInput">時刻:</label>
      <input type="text" id="timeInput" placeholder="例: 16:30, 16:30-16:35, 16:30 5, 16:30 -5">
    </div>
    
    <!-- 形式認識の候補を常時表示 -->
    <div id="timeFormatInfo">
      <span id="formatSingle">単一時刻</span>
      <span id="formatRange">時刻レンジ</span>
      <span id="formatFuture">連続登録（未来方向）</span>
      <span id="formatPast">連続登録（過去方向）</span>
    </div>
    
    <div class="button-group">
      <button id="registerActivityButton">登録</button>
      <button id="deleteActivityButton" class="delete">削除</button>
    </div>
    <div id="activityMessage"></div>
  </div>

  <script>
    // グローバルな設定
    const SUPABASE_PROJECT_ID = 'xalrqqutkxzwzvahqpjg';
    const SUPABASE_URL = `https://${SUPABASE_PROJECT_ID}.supabase.co`;
    let HEADERS;
    let supabaseClient;
    let USER_ID = null;

    window.onload = async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const SUPABASE_KEY = urlParams.get('supabase_key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhbHJxcXV0a3h6d3p2YWhxcGpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzkyNDE2MDIsImV4cCI6MjA1NDgxNzYwMn0.OzfyNlLHmZJOiWnCgsUCnvA9npaDXzVeASr-HVOT1MA';

      HEADERS = {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json'
      };

      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: {
          autoRefreshToken: true,
          persistSession: true,
          detectSessionInUrl: true
        }
      });

      // セッション初期化を待機
      await initializeWithSession();

      // イベントリスナーの設定を確実に行う
      const registerButton = document.getElementById('registerActivityButton');
      const deleteButton = document.getElementById('deleteActivityButton');
      
      if (registerButton) {
        registerButton.addEventListener('click', registerActivity);
      }
      
      if (deleteButton) {
        deleteButton.addEventListener('click', deleteActivity);
      }

      // 時刻入力欄の初期値設定
      const timeInput = document.getElementById('timeInput');
      const now = new Date();
      const hh = now.getHours().toString().padStart(2, '0');
      const mm = now.getMinutes().toString().padStart(2, '0');
      timeInput.value = `${hh}:${mm}`;
      updateFormatDisplay();
    };

    async function initializeWithSession() {
      const { data: { user }, error } = await supabaseClient.auth.getUser();
      if (error || !user) {
        console.error('ユーザー情報取得エラー:', error);
        window.location.href = 'auth_test_login.html';
        return;
      }
      USER_ID = user.id;
      console.log('ユーザーID取得:', USER_ID);
    }

    // 時刻入力欄および形式認識表示更新用の関数
    const timeInput = document.getElementById('timeInput');
    
    function updateFormatDisplay() {
      const val = timeInput.value.trim();
      const rangePattern = /^(\d{1,2}):(\d{2})\s*[-]\s*(\d{1,2}):(\d{2})$/;
      const durationPattern = /^(\d{1,2}):(\d{2})\s+(-?\d+)$/;
      const singleTimePattern = /^(\d{1,2}):(\d{2})$/;
      let matched = null;
      if (rangePattern.test(val)) {
        matched = "range";
      } else if (durationPattern.test(val)) {
        const m = val.match(durationPattern);
        matched = (parseInt(m[3], 10) >= 0) ? "future" : "past";
      } else if (singleTimePattern.test(val)) {
        matched = "single";
      }
      
      // すべての候補のハイライトをリセット
      document.getElementById('formatSingle').classList.remove('highlight');
      document.getElementById('formatRange').classList.remove('highlight');
      document.getElementById('formatFuture').classList.remove('highlight');
      document.getElementById('formatPast').classList.remove('highlight');
      
      // 該当するものをハイライト
      if (matched === "single") {
        document.getElementById('formatSingle').classList.add('highlight');
      } else if (matched === "range") {
        document.getElementById('formatRange').classList.add('highlight');
      } else if (matched === "future") {
        document.getElementById('formatFuture').classList.add('highlight');
      } else if (matched === "past") {
        document.getElementById('formatPast').classList.add('highlight');
      }
      
      // 入力が正規表現のいずれかにマッチしていれば下線を付与
      if (matched) {
        timeInput.classList.add('valid-format');
      } else {
        timeInput.classList.remove('valid-format');
      }
    }
    
    // 登録ボタン押下時の処理（Supabase の RPC 関数 append_pc_activity を利用）
    async function registerActivity() {
      // PC ID の取得
      let pcId;
      const pcSelect = document.getElementById('pcIdSelect');
      if (pcSelect.value === 'other') {
        pcId = document.getElementById('pcIdOther').value.trim();
        if (!pcId) {
          document.getElementById('activityMessage').innerHTML =
            `<div class="error">PC IDを入力してください</div>`;
          return;
        }
      } else {
        pcId = pcSelect.value;
      }
      
      // User ID の取得（セッションから取得）
      if (!USER_ID) {
        document.getElementById('activityMessage').innerHTML =
          `<div class="error">ユーザー情報の取得に失敗しました</div>`;
        return;
      }
      
      const userId = USER_ID;
      
      const timeStr = timeInput.value.trim();
      if (!timeStr) {
        document.getElementById('activityMessage').innerHTML =
          `<div class="error">時刻を入力してください</div>`;
        return;
      }
      
      let parsed;
      try {
        parsed = parseTimeInput(timeStr);
      } catch (error) {
        document.getElementById('activityMessage').innerHTML =
          `<div class="error">${error.message}</div>`;
        return;
      }
      
      try {
        // RPC 経由で関数を呼び出す（HEADERS を利用）
        const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/append_pc_activity`, {
          method: 'POST',
          headers: HEADERS,
          body: JSON.stringify({
            p_pc_id: pcId,
            p_user_id: userId,
            p_minutes: parsed.times
          })
        });
        if (!response.ok) throw new Error('登録に失敗しました');
        const insertedRows = await response.json();
        const insertedCount = insertedRows.length;
        const duplicateCount = parsed.times.length - insertedCount;
        let msg = `${insertedCount}件登録しました`;
        if (duplicateCount > 0) {
          msg += `（既に登録済み: ${duplicateCount}件）`;
        }
        document.getElementById('activityMessage').innerHTML =
          `<div class="success">${msg}</div>`;
      } catch (error) {
        document.getElementById('activityMessage').innerHTML =
          `<div class="error">エラー: ${error.message}</div>`;
      }
    }

    // 削除ボタン押下時の処理（Supabase の RPC 関数 delete_pc_activity を利用）
    async function deleteActivity() {
      // PC ID の取得
      let pcId;
      const pcSelect = document.getElementById('pcIdSelect');
      if (pcSelect.value === 'other') {
        pcId = document.getElementById('pcIdOther').value.trim();
        if (!pcId) {
          document.getElementById('activityMessage').innerHTML =
            `<div class="error">PC IDを入力してください</div>`;
          return;
        }
      } else {
        pcId = pcSelect.value;
      }
      
      // User ID の取得（セッションから取得）
      if (!USER_ID) {
        document.getElementById('activityMessage').innerHTML =
          `<div class="error">ユーザー情報の取得に失敗しました</div>`;
        return;
      }
      
      const userId = USER_ID;
      
      const timeStr = timeInput.value.trim();
      if (!timeStr) {
        document.getElementById('activityMessage').innerHTML =
          `<div class="error">時刻を入力してください</div>`;
        return;
      }
      
      let parsed;
      try {
        parsed = parseTimeInput(timeStr);
      } catch (error) {
        document.getElementById('activityMessage').innerHTML =
          `<div class="error">${error.message}</div>`;
        return;
      }

      // 削除確認
      if (!confirm(`${parsed.times.length}件のアクティビティを削除しますか？`)) {
        return;
      }
      
      try {
        // RPC 経由で削除関数を呼び出す（HEADERS を利用）
        const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/delete_pc_activity`, {
          method: 'POST',
          headers: HEADERS,
          body: JSON.stringify({
            p_pc_id: pcId,
            p_user_id: userId,
            p_minutes: parsed.times
          })
        });
        if (!response.ok) throw new Error('削除に失敗しました');
        const deletedRows = await response.json();
        const deletedCount = deletedRows.length;
        const notFoundCount = parsed.times.length - deletedCount;
        let msg = `${deletedCount}件削除しました`;
        if (notFoundCount > 0) {
          msg += `（該当するデータがなかった項目: ${notFoundCount}件）`;
        }
        document.getElementById('activityMessage').innerHTML =
          `<div class="success">${msg}</div>`;
      } catch (error) {
        document.getElementById('activityMessage').innerHTML =
          `<div class="error">エラー: ${error.message}</div>`;
      }
    }
    
    // 時刻入力欄および形式認識表示の初期化
    window.addEventListener('load', () => {
      const now = new Date();
      const hh = now.getHours().toString().padStart(2, '0');
      const mm = now.getMinutes().toString().padStart(2, '0');
      timeInput.value = `${hh}:${mm}`;
      updateFormatDisplay();
    });
    
    // 時刻入力欄の内容が変わるたびに形式表示を更新
    timeInput.addEventListener('input', updateFormatDisplay);
    
    // 「その他」を選択した場合、PC ID入力欄を表示
    document.getElementById('pcIdSelect').addEventListener('change', function() {
      if (this.value === 'other') {
        document.getElementById('pcIdOther').style.display = 'inline-block';
      } else {
        document.getElementById('pcIdOther').style.display = 'none';
      }
    });
    
    /*---------------------------------------------
      入力された「時刻」文字列をパースする関数
      対応形式：
      1. 単一時刻: "16:30"
      2. 時刻レンジ: "16:30-16:35" または "16:30 16:35"
      3. 連続登録:
         - 未来方向: "16:30 5" → 16:30～16:34 の5分分登録
         - 過去方向: "16:30 -5" → 16:30 とその直前4分（計5分）の登録
    ---------------------------------------------*/
    function parseTimeInput(inputStr) {
      inputStr = inputStr.trim();
      const rangePattern = /^(\d{1,2}):(\d{2})\s*[-]\s*(\d{1,2}):(\d{2})$/;
      const durationPattern = /^(\d{1,2}):(\d{2})\s+(-?\d+)$/;
      const singleTimePattern = /^(\d{1,2}):(\d{2})$/;
      
      // ① 時刻レンジ
      if (rangePattern.test(inputStr)) {
        const m = inputStr.match(rangePattern);
        const start = parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
        const end   = parseInt(m[3], 10) * 60 + parseInt(m[4], 10);
        if (end < start) throw new Error("終了時刻は開始時刻より後である必要があります");
        const times = [];
        for (let t = start; t <= end; t++) {
          times.push(t);
        }
        return { type: 'range', times: times };
      }
      // ② 連続登録（未来方向 or 過去方向）
      else if (durationPattern.test(inputStr)) {
        const m = inputStr.match(durationPattern);
        const start = parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
        const duration = parseInt(m[3], 10);
        let times = [];
        if (duration >= 0) {
          for (let i = 0; i < duration; i++) {
            times.push(start + i);
          }
          return { type: 'duration_future', times: times };
        } else {
          const d = Math.abs(duration);
          for (let i = 0; i < d; i++) {
            times.push(start - d + 1 + i);
          }
          return { type: 'duration_past', times: times };
        }
      }
      // ③ 単一時刻
      else if (singleTimePattern.test(inputStr)) {
        const m = inputStr.match(singleTimePattern);
        const t = parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
        return { type: 'single', times: [t] };
      }
      else {
        throw new Error("入力形式が正しくありません。例: '16:30'、'16:30-16:35'、'16:30 5'、'16:30 -5'");
      }
    }
  </script>
</body>
</html>